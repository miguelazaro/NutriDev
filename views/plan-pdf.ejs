<!doctype html>
<html lang="es">

<head>
    <meta charset="utf-8" />
    <title>
        <%= plan.titulo %> - NutriDev
    </title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        /* ======== Reset y base ======== */
        * {
            box-sizing: border-box;
        }

        html,
        body {
            margin: 0;
            padding: 0;
        }

        body {
            font-family: Arial, Helvetica, sans-serif;
            color: #111827;
        }

        /* ======== Layout ======== */
        .page {
            /* antes: padding: 22mm 16mm 18mm; */
            padding: 8mm 8mm 10mm;
            /* mucho más compacto */
        }

        /* ======== Encabezado ======== */
        .header {
            display: flex;
            align-items: center;
            gap: 14px;
            margin-bottom: 12px;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .brand img {
            width: 42px;
            height: 42px;
            object-fit: contain;
        }

        .brand h2 {
            margin: 0;
            font-size: 18px;
            color: #047857;
            /* verde corporativo */
            letter-spacing: 0.2px;
        }

        .clinic-meta {
            margin-left: auto;
            text-align: right;
            font-size: 11px;
            color: #6B7280;
            line-height: 1.35;
        }

        .rule {
            height: 1px;
            background: #E5E7EB;
            border: 0;
            margin: 8px 0 18px;
        }

        /* ======== Título y meta ======== */
        .title {
            margin: 0 0 4px;
            font-size: 22px;
            color: #047857;
        }

        .subtitle {
            margin: 0 0 10px;
            font-size: 12px;
            color: #6B7280;
        }

        .badge {
            font-weight: 700;
        }

        .badge.ia {
            color: #7C3AED;
        }

        .badge.manual {
            color: #047857;
        }

        /* ======== Resumen paciente ======== */
        .summary {
            width: 100%;
            border: 1px solid #E5E7EB;
            border-radius: 8px;
            background: #FAFAFA;
            padding: 12px;
            margin: 10px 0 16px;
        }

        .summary h3 {
            margin: 0 0 8px;
            font-size: 14px;
            color: #111827;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px 18px;
            font-size: 12.5px;
        }

        .summary-grid .label {
            color: #6B7280;
            font-weight: 600;
        }

        .summary-grid .value {
            color: #111827;
            font-weight: 600;
        }

        .summary-grid .preferencias {
            grid-column: 1 / span 2;
            margin-top: 6px;
            display: flex;
            flex-wrap: wrap;
        }

        .summary-grid .preferencias .label {
            font-weight: 700;
            white-space: nowrap;
            margin-right: 4px;
            /* Mantiene el label en línea con el texto */
        }

        .summary-grid .preferencias .value {
            flex: 1;
            min-width: 200px;
            /* Ajusta según necesidad */
            word-break: break-word;
        }

        /* Nueva regla para controlar el flujo del texto */
        .preferences-content {
            display: inline;
        }

        /* ======= Grid semanal ======= */
        /* Resumen más pegado y sin corte después */
        .summary {
            /* lo demás igual */
            margin: 8px 0 4mm;
            /* antes 10px 0 16px */
            page-break-inside: avoid;
            break-inside: avoid;
            page-break-after: avoid;
            break-after: avoid;
        }

        /* Grid semanal: que NO fuerce salto y quede pegado al resumen */
        .week-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            /* sigues con 3 columnas */
            gap: 10mm 8mm;
            margin-top: 3mm;
            /* antes 8mm */
            page-break-before: avoid;
            break-before: avoid;
        }

        /* Cada tarjeta no se corta */
        .day-card {
            /* lo demás igual */
            page-break-inside: avoid;
            break-inside: avoid;
        }

        /* Encabezado un poco más compacto */
        .rule {
            margin: 6px 0 12px;
        }

        /* antes 8px 0 18px */

        .day-title {
            font-size: 16px;
            font-weight: 800;
            letter-spacing: .5px;
            margin: 0 0 6px;
            position: relative;
            color: #0B3B2E;
        }

        .day-title::after {
            content: "";
            position: absolute;
            left: 0;
            right: 60%;
            bottom: -2px;
            height: 6px;
            background: #E6F4EF;
            z-index: -1;
            border-radius: 3px;
        }

        .meal {
            margin-top: 6px;
        }

        .meal-name {
            font-weight: 700;
            margin: 6px 0 4px;
        }

        .meal-list {
            margin: 0;
            padding-left: 16px;
        }

        .meal-list li {
            margin: 2px 0;
            list-style: none;
            position: relative;
            padding-left: 14px;
        }

        .meal-list li::before {
            content: "";
            position: absolute;
            left: 0;
            top: .45em;
            width: 8px;
            height: 8px;
            background: #10B981;
            border-radius: 2px;
            opacity: .9;
        }

        .week-grid {
            grid-template-columns: 1fr 1fr 1fr;
        }

        /* ======== Pie ======== */
        .footer {
            margin-top: 22px;
            font-size: 11px;
            color: #9CA3AF;
            text-align: right;
        }
    </style>
</head>

<body>
    <div class="page">

        <!-- Encabezado -->
        <div class="header">
            <div class="brand">
                <img src="<%= logoSrc %>" alt="NutriDev" style="height: 65px; width: auto;" />
            </div>
            <div class="clinic-meta">
                <div>Plan nutricional personalizado</div>
                <div>Generado por el sistema • <%= new Date().toLocaleDateString('es-MX') %>
                </div>
            </div>
        </div>
        <hr class="rule" />

        <!-- Título y meta -->
        <h1 class="title">
            <%= plan.titulo %>
        </h1>

        <p class="subtitle">
            Tipo:
            <span class="badge <%= plan.tipo === 'ia' ? 'ia' : 'manual' %>">
                <%= plan.tipo==='ia' ? 'Generado por IA' : 'Manual' %>
            </span>
            · Creado:
            <span>
                <%= new Date(plan.createdAt).toLocaleString('es-MX') %>
            </span>
        </p>

        <!-- Resumen del paciente -->
        <div class="summary">
            <h3>Resumen del paciente</h3>

            <div class="summary-grid">
                <div><span class="label">Nombre:</span> <span class="value">
                        <%= plan.paciente ? plan.paciente.nombre : '—' %>
                    </span></div>
                <div><span class="label">Edad:</span> <span class="value">
                        <%= (edadPaciente ?? '—' ) %>
                    </span></div>

                <div><span class="label">Estatura:</span> <span class="value">
                        <%= plan.paciente && plan.paciente.estatura ? plan.paciente.estatura + ' cm' : '—' %>
                    </span></div>
                <div><span class="label">Objetivo:</span> <span class="value">
                        <%= plan.paciente && plan.paciente.objetivo ? plan.paciente.objetivo : '—' %>
                    </span></div>

                <div><span class="label">Comidas al día:</span> <span class="value">
                        <%= plan.paciente && plan.paciente.comidas_dia ? plan.paciente.comidas_dia : '—' %>
                    </span></div>
                <div><span class="label">Actividad física:</span> <span class="value">
                        <%= plan.paciente && plan.paciente.actividad ? plan.paciente.actividad : '—' %>
                    </span></div>

                <!-- Preferencias ocupa todo el ancho en 2 columnas: etiqueta fija + contenido fluido -->
                <div class="preferencias">
                    <span class="label">Preferencias:</span>
                    <span class="value preferences-content">
                        <%= plan.paciente && plan.paciente.preferencias ? plan.paciente.preferencias.replace(/\n/g, ' '
                            ).trim() : '—' %>
                    </span>
                </div>
            </div>
        </div>

        <% if (week && week.length) { %>
            <div class="week-grid">
                <% week.forEach(function(dia){ %>
                    <section class="day-card">
                        <div class="day-title">
                            <%= dia.day.toUpperCase() %>
                        </div>

                        <% dia.meals.forEach(function(meal){ if (meal.items && meal.items.length) { %>
                            <div class="meal">
                                <div class="meal-name">
                                    <%= meal.title %>:
                                </div>
                                <ul class="meal-list">
                                    <% meal.items.forEach(function(it){ %>
                                        <li>
                                            <%= it %>
                                        </li>
                                        <% }) %>
                                </ul>
                            </div>
                            <% } }) %>
                    </section>
                    <% }) %>
            </div>
            <% } else { %>

                <!-- Fallback SOLO si no se pudo parsear la semana -->
                <div class="content"><%- contenidoSeguro %></div>
                <% } %>

                    <!-- Pie -->
                    <div class="footer">
                        NutriDev · Plan ID: <%= plan.id %>
                    </div>
    </div>
</body>

</html>