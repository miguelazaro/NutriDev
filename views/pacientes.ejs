<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 space-y-6">

  <!-- NOTIFICACI칍N FLASH AUTOCENTRADA -->
  <% if (messages.success && messages.success.length> 0) { %>
    <div id="flash-message"
      class="fixed top-6 left-1/2 -translate-x-1/2 bg-green-100 border border-green-400 text-green-800 text-sm px-4 py-2 rounded shadow z-50 transition-all duration-500">
      <%= messages.success[0] %>
    </div>
    <% } %>

      <% if (messages.error && messages.error.length> 0) { %>
        <div id="flash-message"
          class="fixed top-6 left-1/2 -translate-x-1/2 bg-red-100 border border-red-400 text-red-800 text-sm px-4 py-2 rounded shadow z-50 transition-all duration-500">
          <%= messages.error[0] %>
        </div>
        <% } %>


          <!-- ENCABEZADO -->
          <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
            <div>
              <h1 class="text-3xl font-bold text-emerald-700">Gesti칩n de pacientes</h1>
              <p class="text-sm text-gray-500">Administra los registros cl칤nicos y evolutivos de tus pacientes.</p>
            </div>
            <a href="/pacientes/nuevo"
              class="inline-flex items-center gap-2 bg-emerald-500 hover:bg-emerald-600 text-white font-semibold px-4 py-2 rounded-lg shadow transition-all duration-300">
              <i class="fas fa-user-plus"></i>
              Nuevo paciente
            </a>
          </div>
          <div class="flex flex-col lg:flex-row gap-6">


            <!-- LISTADO PRINCIPAL -->
            <div class="w-full lg:w-2/3 space-y-4">

              <!-- FILTROS Y B칔SQUEDA -->
              <div class="bg-white rounded-lg shadow p-4 flex flex-col sm:flex-row gap-4 sm:items-end">
                <div class="flex-1">
                  <label class="block text-sm font-medium text-gray-700 mb-1">Buscar paciente</label>
                  <input id="searchInput" type="text" placeholder="Nombre, edad, historial..."
                    class="w-full border border-gray-300 rounded p-2 focus:ring-emerald-500 focus:border-emerald-500" />
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Filtrar</label>
                  <select id="filter"
                    class="border border-gray-300 rounded p-2 w-full focus:ring-emerald-500 focus:border-emerald-500">
                    <option>Todos</option>
                    <option>Con seguimiento</option>
                    <option>Sin seguimiento</option>
                  </select>
                </div>
              </div>

              <!-- LISTADO DE PACIENTES -->
              <div id="pacientesList" class="space-y-4">
                <% if (pacientes.length===0) { %>
                  <div class="bg-white p-6 rounded-lg shadow text-center text-gray-500">
                    <i class="fas fa-user-times text-4xl mb-3 text-gray-300"></i>
                    <p>No hay pacientes registrados.</p>
                  </div>
                  <% } else { %>
                    <% pacientes.forEach(p=> {
                      let edadTexto = '';
                      let edadNumero = null;
                      if (p.fecha_nacimiento) {
                      const hoy = new Date();
                      const nacimiento = new Date(p.fecha_nacimiento);
                      let edad = hoy.getFullYear() - nacimiento.getFullYear();
                      const mes = hoy.getMonth() - nacimiento.getMonth();
                      if (mes < 0 || (mes===0 && hoy.getDate() < nacimiento.getDate())) edad--; edadTexto=edad + ' a침os'
                        ; edadNumero=edad; } let fechaRegistro='No registrado' ; if (p.fecha_registro) { const fecha=new
                        Date(p.fecha_registro); fechaRegistro=fecha.toLocaleDateString('es-MX'); } %>
                        <div
                          class="bg-white p-4 rounded-lg shadow flex flex-col md:flex-row justify-between items-start md:items-center gap-4 paciente"
                          data-nombre="<%= p.nombre.toLowerCase() %>" data-edad="<%= edadNumero || '' %>"
                          data-historial="<%= (p.historial || '').toLowerCase() %>"
                          data-telefono="<%= p.telefono || '' %>" data-email="<%= p.email || '' %>">

                          <div class="flex items-start gap-4">



                            <div
                              class="w-10 h-10 rounded-full overflow-hidden bg-emerald-100 flex items-center justify-center">
                              <% if (p.foto) { %>
                                <img src="/uploads/pacientes/<%= p.foto %>" alt="Foto de perfil"
                                  class="object-cover w-full h-full">
                                <% } else { %>
                                  <i class="fas fa-user text-emerald-600 text-xl"></i>
                                  <% } %>
                            </div>







                            <div class="space-y-1">
                              <h3 class="text-lg font-semibold text-gray-800">
                                <%= p.nombre %>
                              </h3>
                              <p class="text-sm text-gray-600">Edad: <%= edadTexto || 'Sin especificar' %>
                              </p>
                              <p class="text-sm text-gray-600">Registrado el: <%= fechaRegistro %>
                              </p>
                              <p class="text-sm text-gray-500 truncate">游늶 <%= p.historial || 'Sin historial registrado'
                                  %>
                              </p>
                              <p class="text-sm text-gray-500">游 <%= p.telefono || 'Sin tel칠fono' %> | 九괦잺 <%= p.email
                                    || 'Sin email' %>
                              </p>
                            </div>
                          </div>

                          <div class="flex gap-2 self-start md:self-center">
                            <a href="/pacientes/<%= p.id %>"
                              class="btn-icon bg-emerald-100 text-emerald-600 hover:bg-emerald-200"
                              title="Ver detalles">
                              <i class="fas fa-eye"></i>
                            </a>
                            <a href="/pacientes/editar/<%= p.id %>"
                              class="btn-icon bg-blue-100 text-blue-600 hover:bg-blue-200" title="Editar">
                              <i class="fas fa-pen"></i>
                            </a>
                            <form action="/pacientes/eliminar/<%= p.id %>" method="POST"
                              onsubmit="return confirm('쮼liminar este paciente?')">
                              <button type="submit" class="btn-icon bg-red-100 text-red-600 hover:bg-red-200"
                                title="Eliminar">
                                <i class="fas fa-trash"></i>
                              </button>
                            </form>
                          </div>
                        </div>
                        <% }) %>
                          <% } %>
              </div>
            </div>

            <!-- ESTAD칈STICAS -->
            <div class="w-full lg:w-1/3">
              <!-- Tarjeta de estad칤sticas -->
              <div class="bg-white shadow rounded-lg p-4 space-y-6">
                <h2 class="text-lg font-semibold text-gray-800">Estad칤sticas</h2>

                <div class="space-y-4">
                  <div>
                    <p class="text-sm text-gray-500">Total de pacientes</p>
                    <p id="totalPacientes" class="text-2xl font-bold text-gray-800">
                      <%= pacientes.length %>
                    </p>
                  </div>
                  <div>
                    <p class="text-sm text-gray-500">Nuevos este mes</p>
                    <p class="text-2xl font-bold text-gray-800">
                      <%= nuevosEsteMes %>
                    </p>
                  </div>
                </div>
              </div>

              <!-- Gr치fico con tama침o controlado correctamente -->
              <div class="bg-white shadow rounded-lg p-4 mt-6">
                <h3 class="text-sm font-semibold text-gray-700 mb-2">Distribuci칩n por edad</h3>
                <div class="relative w-full" style="height: 180px;">
                  <canvas id="edadChart"></canvas>
                </div>
              </div>


            </div>
          </div>
</div>

<style>
  .btn-icon {
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 9999px;
    transition: background-color 0.2s ease;
  }
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    let distribucionEdades = {};
    try {
      distribucionEdades = JSON.parse('<%- JSON.stringify(distribucionEdades) %>');
    } catch (error) {
      console.error("Error al parsear distribuci칩n de edades", error);
    }

    const ctx = document.getElementById('edadChart').getContext('2d');
    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: Object.keys(distribucionEdades),
        datasets: [{
          label: 'Pacientes',
          data: Object.values(distribucionEdades),
          backgroundColor: ['rgba(16,185,129,0.7)', 'rgba(59,130,246,0.7)', 'rgba(139,92,246,0.7)', 'rgba(245,158,11,0.7)', 'rgba(239,68,68,0.7)'],
          borderColor: ['rgba(16,185,129,1)', 'rgba(59,130,246,1)', 'rgba(139,92,246,1)', 'rgba(245,158,11,1)', 'rgba(239,68,68,1)'],
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false, 
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: function (context) {
                return `Pacientes: ${context.raw}`;
              }
            }
          }
        },
        scales: {
          y: { beginAtZero: true, ticks: { precision: 0, stepSize: 1 }, grid: { display: false } },
          x: { grid: { display: false } }
        }
      }
    });


    // Buscador en vivo
    const searchInput = document.getElementById('searchInput');
    const pacientes = document.querySelectorAll('.paciente');
    const pacientesList = document.getElementById('pacientesList');
    const totalPacientes = document.getElementById('totalPacientes');

    function filtrarPacientes() {
      const term = searchInput.value.toLowerCase().trim();
      let visibleCount = 0;

      pacientes.forEach(paciente => {
        const nombre = paciente.dataset.nombre;
        const edad = paciente.dataset.edad;
        const historial = paciente.dataset.historial;
        const telefono = paciente.dataset.telefono;
        const email = paciente.dataset.email;

        const matches = nombre.includes(term) || (edad && edad.includes(term)) ||
          historial.includes(term) || telefono.includes(term) || email.includes(term);

        if (matches || term === '') {
          paciente.style.display = '';
          visibleCount++;
        } else {
          paciente.style.display = 'none';
        }
      });

      totalPacientes.textContent = visibleCount;
      if (visibleCount === 0) {
        pacientesList.innerHTML = `
          <div class="bg-white p-6 rounded-lg shadow text-center text-gray-500">
            <i class="fas fa-search text-4xl mb-3 text-gray-300"></i>
            <p>No se encontraron pacientes.</p>
          </div>`;
      }
    }

    searchInput.addEventListener('input', filtrarPacientes);
    searchInput.addEventListener('keypress', e => {
      if (e.key === 'Enter') filtrarPacientes();
    });
  });
</script>
<script>
  setTimeout(() => {
    const flash = document.getElementById('flash-message');
    if (flash) {
      flash.style.opacity = '0';
      setTimeout(() => flash.remove(), 500); // animaci칩n antes de eliminar
    }
  }, 5000); // 5 segundos
</script>