<div class="max-w-5xl mx-auto bg-white p-6 sm:p-8 shadow rounded-lg space-y-6">

    <!-- ENCABEZADO -->
    <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
        <!-- FOTO DE PERFIL + NOMBRE -->
        <div class="flex items-center gap-4">
            <div class="w-16 h-16 sm:w-20 sm:h-20 rounded-full overflow-hidden border-4 border-emerald-300 shadow">
                <% if (paciente.foto) { %>
                    <img src="/uploads/pacientes/<%= paciente.foto %>" alt="Foto de perfil"
                        class="object-cover w-full h-full">
                    <% } else { %>
                        <i
                            class="fas fa-user text-emerald-600 text-2xl flex items-center justify-center w-full h-full bg-emerald-100"></i>
                        <% } %>
            </div>
            <div>
                <h1 class="text-2xl sm:text-3xl font-bold text-emerald-600">
                    <%= paciente.nombre %>
                </h1>
                <p class="text-sm text-gray-500">Ficha del paciente</p>
            </div>
        </div>
        <div class="mb-4">
            <a href="/pacientes" class="inline-flex items-center text-sm font-medium text-emerald-600 hover:underline">
                <i class="fas fa-arrow-left mr-2"></i>
                Volver a la lista de pacientes
            </a>
        </div>
    </div>

        <!-- INFO GENERAL + RESUMEN CL√çNICO -->
    <section class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 text-sm">
        <div class="bg-gray-50 p-4 rounded-lg shadow">
            <p class="text-gray-500">Edad</p>
            <p class="font-semibold">
                <% if (paciente.fecha_nacimiento) { 
                    const nacimiento = new Date(paciente.fecha_nacimiento); 
                    const hoy = new Date(); 
                    let edad = hoy.getFullYear() - nacimiento.getFullYear(); 
                    const m = hoy.getMonth() - nacimiento.getMonth(); 
                    if (m < 0 || (m === 0 && hoy.getDate() < nacimiento.getDate())) edad--; 
                %>
                    <%= edad %> a√±os
                <% } else { %>
                    No especificada
                <% } %>
            </p>
        </div>

        <div class="bg-gray-50 p-4 rounded-lg shadow">
            <p class="text-gray-500">Sexo</p>
            <p class="font-semibold">
                <%= paciente.genero || 'No especificado' %>
            </p>
        </div>

        <div class="bg-gray-50 p-4 rounded-lg shadow">
            <p class="text-gray-500">Estatura</p>
            <p class="font-semibold">
                <%= paciente.estatura ? paciente.estatura + ' cm' : 'No especificada' %>
            </p>
        </div>

        <div class="bg-gray-50 p-4 rounded-lg shadow">
            <p class="text-gray-500">Correo</p>
            <p class="font-semibold">
                <%= paciente.email || 'No especificado' %>
            </p>
        </div>

        <div class="bg-gray-50 p-4 rounded-lg shadow">
            <p class="text-gray-500">Tel√©fono</p>
            <p class="font-semibold">
                <%= paciente.telefono || 'No especificado' %>
            </p>
        </div>

        <div class="bg-gray-50 p-4 rounded-lg shadow">
            <p class="text-gray-500">Pa√≠s</p>
            <p class="font-semibold">
                <%= paciente.pais_residencia || 'No especificado' %>
            </p>
        </div>

          <div class="bg-gray-50 p-4 rounded-lg shadow">
            <p class="text-gray-500">Ocupaci√≥n</p>
            <p class="font-semibold">
                <%= paciente.ocupacion || 'No especificada' %>
            </p>
        </div>
    </section>

    <!-- RESUMEN CL√çNICO COMPLETO -->
   <section class="grid grid-cols-1 md:grid-cols-2 gap-6">

    <!-- Motivo de consulta -->
    <div class="bg-white border border-gray-200 rounded-xl shadow p-6">
        <h2 class="text-lg font-semibold text-emerald-700 mb-2">üìù Motivo de consulta</h2>
        <p><span class="font-semibold">Objetivo:</span> <%= paciente.objetivo || 'Sin objetivo definido' %></p>
        <p><span class="font-semibold">Meta espec√≠fica:</span> <%= paciente.meta_especifica || 'No registrada' %></p>
        <p><span class="font-semibold">Prioridad:</span> <%= paciente.prioridad_objetivo || 'No indicada' %></p>
    </div>

    <!-- Medici√≥n f√≠sica -->
    <div class="bg-white border border-gray-200 rounded-xl shadow p-6">
        <h2 class="text-lg font-semibold text-emerald-700 mb-2">‚öñÔ∏è Medici√≥n f√≠sica</h2>
        <p><span class="font-semibold">Peso:</span> <%= paciente.peso ? paciente.peso + ' kg' : 'Sin registrar' %> ¬∑
           <span class="font-semibold">Estatura:</span> <%= paciente.estatura ? paciente.estatura + ' cm' : 'Sin registrar' %></p>

        <p><span class="font-semibold">% grasa:</span> <%= paciente.porcentaje_grasa || 'Sin registrar' %> ¬∑
           <span class="font-semibold">Cintura:</span> <%= paciente.circunferencia_cintura ? paciente.circunferencia_cintura + ' cm' : 'Sin registrar' %></p>

        <p><span class="font-semibold">Presi√≥n arterial:</span> <%= paciente.presion_arterial || 'Sin registrar' %></p>
    </div>

    <!-- Estilo de vida -->
    <div class="bg-white border border-gray-200 rounded-xl shadow p-6">
        <h2 class="text-lg font-semibold text-emerald-700 mb-2">üèÉ Estilo de vida</h2>

        <p><span class="font-semibold">Actividad f√≠sica:</span> <%= paciente.actividad || 'Sin especificar' %></p>

        <p><span class="font-semibold">Tipo de ejercicio:</span> <%= paciente.tipo_ejercicio || 'Sin registrar' %></p>

        <p>
            <span class="font-semibold">Horas de sue√±o:</span> <%= paciente.horas_sueno || 'Sin registrar' %> ¬∑
            <span class="font-semibold">Calidad:</span> <%= paciente.calidad_sueno || 'Sin registrar' %> ¬∑
            <span class="font-semibold">Estr√©s:</span> <%= paciente.estres || 'Sin registrar' %>
        </p>
    </div>

    <!-- H√°bitos alimenticios -->
    <div class="bg-white border border-gray-200 rounded-xl shadow p-6">
        <h2 class="text-lg font-semibold text-emerald-700 mb-2">üçΩÔ∏è H√°bitos alimenticios</h2>

        <p><span class="font-semibold">Comidas al d√≠a:</span> <%= paciente.comidas_dia || 'Sin registrar' %> ¬∑
           <span class="font-semibold">Preferencia:</span> <%= paciente.preferencia_alimentaria || 'Sin registrar' %></p>

        <p><span class="font-semibold">Consumo de agua:</span> <%= paciente.consumo_agua ? paciente.consumo_agua + ' L' : 'Sin registrar' %></p>

        <p><span class="font-semibold">Apetito:</span> <%= paciente.apetito || 'Sin registrar' %></p>
    </div>

    <!-- Enfermedades y antecedentes -->
<div class="bg-white border rounded-lg p-4 shadow-sm space-y-1 md:col-span-2">
    <h2 class="text-base font-semibold text-emerald-700 mb-1">ü©∫ Enfermedades y antecedentes</h2>

    <!-- Enfermedades diagnosticadas -->
    <p class="mb-1">
        <span class="font-semibold">Enfermedades diagnosticadas:</span>
        <% 
            const enf = [];
            if (paciente.diabetes) enf.push('Diabetes');
            if (paciente.hipertension) enf.push('Hipertensi√≥n');
            if (paciente.higado_graso) enf.push('H√≠gado graso');
            if (paciente.gastritis) enf.push('Gastritis');
        %>
        <%= enf.length ? enf.join(', ') : 'Ninguna registrada' %>
    </p>

    <!-- Otras enfermedades -->
    <p class="mb-1">
        <span class="font-semibold">Otras enfermedades:</span>
        <%= paciente.otras_enfermedades || 'No registradas' %>
    </p>

    <!-- Antecedentes familiares -->
    <p class="mb-1">
        <span class="font-semibold">Antecedentes familiares:</span>
        <% 
            const ant = [];
            if (paciente.diabetes_familiar) ant.push('Diabetes');
            if (paciente.hipertension_familiar) ant.push('Hipertensi√≥n');
            if (paciente.obesidad_familiar) ant.push('Obesidad');
            if (paciente.cancer_familiar) ant.push('C√°ncer');
        %>
        <%= ant.length ? ant.join(', ') : 'No registrados' %>
    </p>

    <!-- Otros antecedentes -->
    <p class="mb-1">
        <span class="font-semibold">Otros antecedentes:</span>
        <%= paciente.otros_antecedentes || 'No registrados' %>
    </p>

    <!-- Alergias -->
    <p class="mb-1">
        <span class="font-semibold">Alergias:</span>
        <%= paciente.alergias || 'No registradas' %>
    </p>

    <!-- Medicaci√≥n actual -->
    <p class="mb-1">
        <span class="font-semibold">Medicaci√≥n actual:</span>
        <%= paciente.medicacion_actual || 'No registrada' %>
    </p>

    <!-- Cirug√≠as previas -->
    <p>
        <span class="font-semibold">Cirug√≠as previas:</span>
        <%= paciente.cirugias_previas || 'No registradas' %>
    </p>
</div>

</section>

<section class="bg-white border rounded-xl p-6 shadow-md mt-8 w-full">

    <h2 class="text-xl font-semibold text-red-700 mb-4 flex items-center gap-2">
         Calculadora de gasto cal√≥rico
    </h2>

    <!-- CAMPOS OBLIGATORIOS -->
    <h3 class="text-sm font-semibold text-gray-700 mb-2">Campos obligatorios</h3>

    <!-- FORMULARIO ANCHO COMPLETO -->
    <div class="grid grid-cols-1 md:grid-cols-6 gap-4">

        <!-- SEXO -->
        <div>
            <label class="text-gray-600 font-medium text-sm">Sexo</label>
            <select id="calc-genero" class="w-full border rounded-lg p-2">
                <option value="Masculino" <%= paciente.genero === 'Masculino' ? 'selected':'' %>>Masculino</option>
                <option value="Femenino" <%= paciente.genero === 'Femenino' ? 'selected':'' %>>Femenino</option>
            </select>
        </div>

        <!-- PESO -->
        <div>
            <label class="text-gray-600 font-medium text-sm">Peso (kg)</label>
            <input id="calc-peso" type="number" class="w-full border rounded-lg p-2"
                value="<%= paciente.peso || '' %>">
        </div>

        <!-- ESTATURA -->
        <div>
            <label class="text-gray-600 font-medium text-sm">Estatura (cm)</label>
            <input id="calc-estatura" type="number" class="w-full border rounded-lg p-2"
                value="<%= paciente.estatura || '' %>">
        </div>

        <!-- EDAD -->
        <div>
            <label class="text-gray-600 font-medium text-sm">Edad (a√±os)</label>
            <input id="calc-edad" type="number" class="w-full border rounded-lg p-2"
                value="<%= edad || '' %>">
        </div>

        <!-- ACTIVIDAD -->
        <div>
            <label class="text-gray-600 font-medium text-sm">Actividad f√≠sica</label>
            <select id="calc-actividad" class="w-full border rounded-lg p-2">
                <option value="sedentario" <%= paciente.actividad==='sedentario'?'selected':'' %>>Sedentario</option>
                <option value="ligero" <%= paciente.actividad==='ligero'?'selected':'' %>>Ligero</option>
                <option value="moderado" <%= paciente.actividad==='moderado'?'selected':'' %>>Moderado</option>
                <option value="intenso" <%= paciente.actividad==='intenso'?'selected':'' %>>Intenso</option>
                <option value="muy_intenso" <%= paciente.actividad==='muy_intenso'?'selected':'' %>>Muy intenso</option>
            </select>
        </div>

        <!-- OBJETIVO -->
        <div>
            <label class="text-gray-600 font-medium text-sm">Objetivo</label>
            <select id="calc-objetivo" class="w-full border rounded-lg p-2">
                <option value="mantener_peso" <%= paciente.objetivo === 'mantener_peso'?'selected':'' %>>Mantener peso</option>
                <option value="bajar_peso" <%= paciente.objetivo === 'bajar_peso'?'selected':'' %>>Bajar peso</option>
                <option value="ganar_musculo" <%= paciente.objetivo === 'ganar_musculo'?'selected':'' %>>Ganar m√∫sculo</option>
            </select>
        </div>

    </div>

    <!-- OPCIONALES -->
    <h3 class="text-sm font-semibold text-gray-700 mt-6 mb-2">Opcionales (no afectan el c√°lculo)</h3>

    <div class="grid grid-cols-1 md:grid-cols-5 gap-4">

        <div>
            <label class="text-gray-600 font-medium text-sm">Cintura (cm)</label>
            <input disabled class="w-full border rounded-lg p-2 bg-gray-100"
                value="<%= paciente.circunferencia_cintura || '' %>">
        </div>

        <div>
            <label class="text-gray-600 font-medium text-sm">% grasa</label>
            <input disabled class="w-full border rounded-lg p-2 bg-gray-100"
                value="<%= paciente.porcentaje_grasa || '' %>">
        </div>

        <div>
            <label class="text-gray-600 font-medium text-sm">Enfermedades</label>
            <input disabled class="w-full border rounded-lg p-2 bg-gray-100"
                value="<%= paciente.otras_enfermedades || 'Ninguna' %>">
        </div>

        <div>
            <label class="text-gray-600 font-medium text-sm">Sue√±o (hrs)</label>
            <input disabled class="w-full border rounded-lg p-2 bg-gray-100"
                value="<%= paciente.horas_sueno || '' %>">
        </div>

        <div>
            <label class="text-gray-600 font-medium text-sm">Estr√©s</label>
            <input disabled class="w-full border rounded-lg p-2 bg-gray-100"
                value="<%= paciente.estres || '' %>">
        </div>

    </div>

    <!-- RESULTADOS -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-8">

        <div class="p-4 border rounded-xl bg-red-50 text-center shadow-sm">
            <p class="text-gray-600 text-sm">TMB (Metabolismo basal)</p>
            <h3 id="calc-tmb" class="text-2xl font-bold text-red-700">‚Äî</h3>
        </div>

        <div class="p-4 border rounded-xl bg-red-50 text-center shadow-sm">
            <p class="text-gray-600 text-sm">TDEE (Gasto total)</p>
            <h3 id="calc-tdee" class="text-2xl font-bold text-red-700">‚Äî</h3>
        </div>

        <div class="p-4 border rounded-xl bg-red-50 text-center shadow-sm">
            <p class="text-gray-600 text-sm">Calor√≠as seg√∫n objetivo</p>
            <h3 id="calc-objetivo-res" class="text-2xl font-bold text-red-700">‚Äî</h3>
        </div>

    </div>

    <!-- BOT√ìN -->
    <div class="text-center mt-6">
        <button onclick="calcular()"
            class="bg-blue-600 hover:bg-blue-700 text-white px-8 py-3 rounded-lg font-semibold shadow">
            CALCULAR
        </button>
    </div>

</section>
    <!-- HISTORIAL Y NOTAS -->
    <section class="grid grid-cols-1 sm:grid-cols-2 gap-4">
        <div class="bg-white border rounded-lg p-4">
            <h2 class="text-lg font-semibold text-emerald-700 mb-2">üìù Historial M√©dico</h2>
            <p class="text-gray-700 italic">
                <%= paciente.historial || 'No registrado' %>
            </p>
        </div>
        <div class="bg-white border rounded-lg p-4">
            <h2 class="text-lg font-semibold text-emerald-700 mb-2">üìí Notas del Nutri√≥logo</h2>
            <form method="POST" action="/pacientes/<%= paciente.id %>/notas">
                <textarea name="nota" class="form-textarea w-full" rows="4"
                    placeholder="Escribe tus notas aqu√≠..."></textarea>
                <button type="submit"
                    class="bg-emerald-500 hover:bg-emerald-600 text-white px-4 py-2 rounded shadow mt-2">Guardar
                    nota</button>
            </form>
            <% if (paciente.NotaNutriologos && paciente.NotaNutriologos.length> 0) { %>
                <ul class="mt-4 space-y-2">
                    <% paciente.NotaNutriologos.forEach(n=> { %>
                        <li class="bg-gray-100 p-2 rounded shadow text-sm flex justify-between items-center">
                            <span>
                                <%= n.nota %>
                            </span>
                            <form action="/pacientes/<%= paciente.id %>/notas/<%= n.id %>/eliminar" method="POST"
                                class="inline">
                                <button type="submit"
                                    class="bg-blue-600 hover:bg-red-600 text-white px-4 py-2 rounded shadow mt-2">Eliminar</button>
                            </form>
                        </li>
                        <% }) %>
                </ul>
                <% } else { %>
                    <p class="text-gray-500 text-sm mt-2">No hay notas registradas.</p>
                    <% } %>
        </div>
    </section>

    <!-- pesta√±as -->
    <div class="flex flex-wrap gap-3 text-sm font-medium">
        <button
            class="tab-button bg-white text-gray-700 border border-gray-300 px-4 py-2 rounded-md shadow-sm hover:bg-blue-50 data-[active=true]:bg-blue-100 data-[active=true]:text-blue-700"
            data-tab="progreso">üìà Progreso</button>
    
        <button
            class="tab-button bg-white text-gray-700 border border-gray-300 px-4 py-2 rounded-md shadow-sm hover:bg-emerald-50 data-[active=true]:bg-emerald-100 data-[active=true]:text-emerald-700"
            data-tab="archivos">üìÇ Archivos</button>
    
        <% if (user && (user.rol==='admin' || user.plan==='premium' )) { %>
            <button
                class="tab-button bg-white text-gray-700 border border-gray-300 px-4 py-2 rounded-md shadow-sm hover:bg-indigo-50 data-[active=true]:bg-indigo-100 data-[active=true]:text-indigo-700"
                data-tab="planes">ü§ñ Plan Alimenticio (IA)</button>
            <% } else { %>
                <!-- Mostrar ‚ÄúPremium‚Äù como CTA a /planes -->
                <a href="/planes"
                    class="bg-white text-gray-500 border border-dashed border-gray-300 px-4 py-2 rounded-md shadow-sm hover:bg-yellow-50"
                    title="Disponible con plan Premium">
                    ü§ñ Plan Alimenticio (IA) <span class="ml-1 text-xs">Premium</span>
                </a>
                <% } %>
   </div>


    <!-- TAB: PROGRESO -->
    <div class="tab-content mt-6 hidden" id="progreso">
        <section class="bg-white border rounded-lg p-4">
            <h2 class="text-lg font-semibold text-blue-700 mb-4">üìà Registrar progreso</h2>
            <form action="/pacientes/<%= paciente.id %>/progreso" method="POST"
                class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                <div>
                    <label class="block text-sm font-medium">Peso (kg)</label>
                    <input type="number" step="0.1" name="peso" required class="w-full border rounded p-2">
                </div>
                <div>
                    <label class="block text-sm font-medium">Fecha</label>
                    <input type="date" name="fecha" class="w-full border rounded p-2">
                </div>
                <div>
                    <label class="block text-sm font-medium">Observaciones</label>
                    <input type="text" name="observaciones" class="w-full border rounded p-2">
                </div>
                <div class="col-span-1 sm:col-span-3">
                    <button type="submit"
                        class="mt-2 bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded shadow">
                        Guardar progreso
                    </button>
                </div>
            </form>
        </section>

        <section class="bg-white border rounded-lg p-4 mt-6">
            <h2 class="text-lg font-semibold text-blue-700 mb-4">üìä Evoluci√≥n de peso</h2>
            <% if (paciente.Progresos && paciente.Progresos.length> 0) { %>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white">
                        <thead>
                            <tr>
                                <th class="py-2 px-4 border-b">Fecha</th>
                                <th class="py-2 px-4 border-b">Peso (kg)</th>
                                <th class="py-2 px-4 border-b">Observaciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% paciente.Progresos.forEach(progreso=> { %>
                                <tr>
                                    <td class="py-2 px-4 border-b">
                                        <%= progreso.fecha %>
                                    </td>
                                    <td class="py-2 px-4 border-b">
                                        <%= progreso.peso %>
                                    </td>
                                    <td class="py-2 px-4 border-b">
                                        <%= progreso.observaciones %>
                                    </td>
                                </tr>
                                <% }); %>
                        </tbody>
                    </table>
                </div>

                <canvas id="graficaProgreso" class="w-full h-64 mt-4"></canvas>
                <% } else { %>
                    <p class="text-gray-500 italic">No hay registros de progreso a√∫n.</p>
                    <% } %>
        </section>
    </div>

    <!-- TAB: ARCHIVOS -->
    <div class="tab-content mt-6" id="archivos">
        <section class="bg-white border rounded-lg p-4">
            <h2 class="text-lg font-semibold text-emerald-700 mb-4">üìÇ Archivos del paciente</h2>
            <form action="/pacientes/<%= paciente.id %>/subir" method="POST" enctype="multipart/form-data"
                class="flex flex-col sm:flex-row items-center gap-4">
                <input type="file" name="archivo" accept="image/*,.pdf" required class="flex-1 border rounded p-2">
                <button type="submit" class="bg-emerald-500 hover:bg-emerald-600 text-white px-4 py-2 rounded shadow">
                    Subir
                </button>
            </form>
            <div class="mt-4 grid grid-cols-2 sm:grid-cols-3 gap-4">
                <% if (paciente.ArchivoPacientes && paciente.ArchivoPacientes.length> 0) { %>
                    <% paciente.ArchivoPacientes.forEach(a=> { %>
                        <div class="border rounded p-2 bg-gray-50 text-center text-sm">
                            <% if (a.tipo==='imagen' ) { %>
                                <img src="<%= a.ruta %>" alt="archivo" class="w-full h-32 object-cover rounded mb-2">
                                <% } else if (a.tipo==='pdf' ) { %>
                                    <i class="fas fa-file-pdf text-red-500 text-4xl mb-2"></i>
                                    <% } %>
                                        <a href="<%= a.ruta %>" target="_blank"
                                            class="text-blue-600 hover:underline block truncate">
                                            <%= a.nombre_archivo %>
                                        </a>
                        </div>
                        <% }) %>
                            <% } else { %>
                                <p class="col-span-2 text-gray-500 italic">No se han subido archivos</p>
                                <% } %>
            </div>
        </section>
    </div>

    <!-- TAB: PLAN ALIMENTICIO -->
    <div class="tab-content mt-6 hidden" id="planes">
        <section class="bg-white border rounded-lg p-4">
            <h2 class="text-lg font-semibold text-indigo-700 mb-4">ü§ñ Plan alimenticio sugerido por IA</h2>
            <p class="text-sm text-gray-600 italic mb-4">
                Aqu√≠ se generar√° autom√°ticamente un plan basado en los progresos,
                historial m√©dico y otros factores del paciente.
            </p>

            <button id="btn-generar-plan" data-id="<%= paciente.id %>"
                class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded">
                Generar Plan IA
            </button>

            <!-- Resultado generado por la IA -->
            <div id="resultado-plan" class="mt-4 whitespace-pre-wrap text-gray-800"></div>

            <form id="form-guardar-plan" class="hidden" method="POST" action="/planes-alimenticios/guardar">
                <input type="hidden" name="contenido" id="input-contenido-plan">
                <input type="hidden" name="paciente_id" value="<%= paciente.id %>">
                <input type="hidden" name="tipo" value="ia">
                <input type="hidden" name="titulo" value="Plan IA generado autom√°ticamente">
                <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 mt-3">
                    Guardar plan
                </button>
            </form>


            <div id="flash" class="mt-3"></div>

    </div>
    </section>
</div>

<script>
function calcular() {
    const peso = parseFloat(document.getElementById("calc-peso").value);
    const estatura = parseFloat(document.getElementById("calc-estatura").value);
    const edad = parseInt(document.getElementById("calc-edad").value);
    const actividad = document.getElementById("calc-actividad").value;
    const genero = document.getElementById("calc-genero").value;
    const objetivo = document.getElementById("calc-objetivo").value;

    if (!peso || !estatura || !edad) return;

    let TMB = 0;

    if (genero === "Masculino") {
        TMB = 88.362 + (13.397 * peso) + (4.799 * estatura) - (5.677 * edad);
    } else {
        TMB = 447.593 + (9.247 * peso) + (3.098 * estatura) - (4.330 * edad);
    }

    const factores = {
        sedentario: 1.2,
        ligero: 1.375,
        moderado: 1.55,
        intenso: 1.725,
        muy_intenso: 1.9
    };

    const TDEE = TMB * (factores[actividad] || 1.2);

    let caloriasObjetivo = TDEE;
    if (objetivo === "bajar_peso") caloriasObjetivo -= 450;
    if (objetivo === "ganar_musculo") caloriasObjetivo += 300;

    document.getElementById("calc-tmb").textContent = Math.round(TMB) + " kcal/d√≠a";
    document.getElementById("calc-tdee").textContent = Math.round(TDEE) + " kcal/d√≠a";
    document.getElementById("calc-objetivo-res").textContent = Math.round(caloriasObjetivo) + " kcal/d√≠a";
}

document.addEventListener("DOMContentLoaded", calcular);
</script>

<script>
  window.pacienteMeta = JSON.parse(
    `<%- JSON.stringify({
      TMB: TMB || 0,
      TDEE: TDEE || 0,
      objetivo: paciente.objetivo || ""
    }) %>`
  );
</script>

<!-- IA Plan Alimenticio -->
<script src="/js/iaPlan.js"></script>

<!-- SCRIPT PARA TABS -->
<script>
    const tabs = document.querySelectorAll(".tab-button");
    const contents = document.querySelectorAll(".tab-content");

    tabs.forEach((btn) => {
        btn.addEventListener("click", () => {
            const tab = btn.getAttribute("data-tab");

            contents.forEach((c) => c.classList.add("hidden"));
            tabs.forEach((t) => t.setAttribute("data-active", "false"));

            document.getElementById(tab).classList.remove("hidden");
            btn.setAttribute("data-active", "true");

            // Si es la pesta√±a de progreso, renderizar la gr√°fica
            if (tab === 'progreso') {
                renderGraficaProgreso();
            }
        });
    });

    // Activar primera pesta√±a
    if (tabs.length > 0) {
        tabs[0].click();
    }
</script>

<!-- Agrega la librer√≠a Chart.js aqu√≠ -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    function renderGraficaProgreso() {
const progresos = <%- JSON.stringify(paciente.Progresos || []) %>;
        const ctx = document.getElementById('graficaProgreso')?.getContext('2d');

        if (!ctx || !progresos || progresos.length === 0) return;

        // Ordenar progresos por fecha
        progresos.sort((a, b) => new Date(a.fecha) - new Date(b.fecha));

        // Destruir gr√°fica anterior si existe
        if (window.graficaProgreso) {
            window.graficaProgreso.destroy();
        }

        window.graficaProgreso = new Chart(ctx, {
            type: 'line',
            data: {
                labels: progresos.map(p => p.fecha),
                datasets: [{
                    label: 'Peso (kg)',
                    data: progresos.map(p => Number(p.peso)),
                    borderColor: 'rgba(37, 99, 235, 1)',
                    backgroundColor: 'rgba(37, 99, 235, 0.1)',
                    borderWidth: 2,
                    tension: 0.3,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    tooltip: {
                        callbacks: {
                            afterBody: function (context) {
                                const idx = context[0].dataIndex;
                                return 'Obs: ' + (progresos[idx].observaciones || 'N/A');
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: false,
                        title: { display: true, text: 'Peso (kg)' }
                    },
                    x: {
                        title: { display: true, text: 'Fecha' }
                    }
                }
            }
        });
    }

    // Renderizar gr√°fica al cargar la p√°gina si estamos en la pesta√±a de progreso
    document.addEventListener('DOMContentLoaded', function () {
        if (!document.getElementById('progreso').classList.contains('hidden')) {
            renderGraficaProgreso();
        }
    });
</script>